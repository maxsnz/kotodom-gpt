generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

model TgUser {
  id    BigInt     @id
  username  String?
  name String?
  fullName  String?
  chats Chat[]
  createdAt DateTime @default(now())
  messages Message[]
}

model Message {
  id    Int     @id @default(autoincrement())
  chat Chat? @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId String?
  tgUser TgUser? @relation(fields: [tgUserId], references: [id])
  tgUserId BigInt?
  bot Bot? @relation(fields: [botId], references: [id])
  botId   Int?
  text String
  telegramUpdateId BigInt?
  userMessage   Message? @relation("UserMessageResponse", fields: [userMessageId], references: [id])
  userMessageId Int?
  botResponses  Message[] @relation("UserMessageResponse")
  processing    MessageProcessing?
  responseProcessing MessageProcessing[] @relation("ResponseMessage")
  createdAt DateTime @default(now())

  @@unique([botId, telegramUpdateId])
}

model Setting {
  id String @id
  value String?
}

enum TelegramModeEnum {
  polling
  webhook
}

enum UserRole {
  ADMIN
  MANAGER
  USER
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum MessageProcessingStatus {
  RECEIVED
  PROCESSING
  COMPLETED
  FAILED
  TERMINAL
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String
  role         UserRole   @default(USER)
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  bots         Bot[]
}

model Bot {
  id    Int     @id @default(autoincrement())
  startMessage String
  errorMessage String @default("")
  name  String
  token String
  model String @default("gpt-4o-mini")
  createdAt DateTime @default(now())
  isActive Boolean @default(false)
  enabled Boolean @default(false)
  messages Message[]
  assistantId String
  error String?
  chats Chat[]
  telegramMode TelegramModeEnum @default(webhook)
  ownerUserId String?
  owner       User?   @relation(fields: [ownerUserId], references: [id])

  @@index([ownerUserId])
}

model Chat {
  id             String   @id
  telegramChatId BigInt
  botId          Int?
  bot            Bot?     @relation(fields: [botId], references: [id])
  threadId       String?
  messages       Message[]
  createdAt      DateTime @default(now())
  tgUser         TgUser   @relation(fields: [tgUserId], references: [id])
  tgUserId       BigInt
  name           String?
}

model MessageProcessing {
  id                        Int                        @id @default(autoincrement())
  userMessage               Message                    @relation(fields: [userMessageId], references: [id], onDelete: Cascade)
  userMessageId             Int                        @unique
  status                    MessageProcessingStatus    @default(RECEIVED)
  attempts                  Int                       @default(0)
  lastError                 String?                   @db.Text
  lastErrorAt               DateTime?
  terminalReason            String?
  responseMessage           Message?                  @relation("ResponseMessage", fields: [responseMessageId], references: [id])
  responseMessageId         Int?
  telegramIncomingMessageId Int?
  telegramOutgoingMessageId Int?
  telegramUpdateId          BigInt?
  responseGeneratedAt       DateTime?
  responseSentAt            DateTime?
  price                     Decimal                    @default(0) @db.Decimal(10, 4)
  createdAt                 DateTime                  @default(now())
  updatedAt                 DateTime                  @updatedAt

  @@index([status])
  @@index([lastErrorAt])
}